<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Which USAJobs Listings Have New Essay Questions?</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    
    <style>
        .tab-content {
            padding: 20px 0;
        }
        .stats-card {
            margin-bottom: 20px;
        }
        .heatmap-table td {
            text-align: center;
            padding: 8px;
        }
        .heatmap-cell {
            background: linear-gradient(to right, #ffffff var(--percent), #0d6efd var(--percent));
        }
        .dataTables_filter {
            display: none;
        }
        tfoot input {
            width: 100%;
            padding: 3px;
            box-sizing: border-box;
        }
        .search-row th {
            padding: 4px !important;
        }
        .search-row input {
            font-weight: normal;
        }
        .filter-tag {
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        .filter-tag .remove-filter {
            cursor: pointer;
            color: #6c757d;
            font-weight: bold;
            margin-left: 0.25rem;
        }
        .filter-tag .remove-filter:hover {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 class="mt-4 mb-4">Which USAJobs Listings Have New Essay Questions?</h1>
                
                <!-- Tabs -->
                <ul class="nav nav-tabs" id="analysisTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">Overview</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="service-tab" data-bs-toggle="tab" data-bs-target="#service" type="button">By Service Type</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="grade-tab" data-bs-toggle="tab" data-bs-target="#grade" type="button">By Grade Level</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="location-tab" data-bs-toggle="tab" data-bs-target="#location" type="button">By Location</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="agency-tab" data-bs-toggle="tab" data-bs-target="#agency" type="button">By Agency</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="occupation-tab" data-bs-toggle="tab" data-bs-target="#occupation" type="button">By Occupation</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline" type="button">Timeline</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="jobs-tab" data-bs-toggle="tab" data-bs-target="#jobs" type="button">Job Listings</button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content" id="analysisTabContent">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card stats-card">
                                    <div class="card-body">
                                        <h5 class="card-title">Total Scraped Questionnaires</h5>
                                        <h2 class="text-primary" id="totalScraped">-</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card stats-card">
                                    <div class="card-body">
                                        <h5 class="card-title">With Essay Question</h5>
                                        <h2 class="text-success" id="totalWithEO">-</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card stats-card">
                                    <div class="card-body">
                                        <h5 class="card-title">Percentage</h5>
                                        <h2 class="text-info" id="percentageWithEO">-</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col-12">
                                <h3>Question Being Tracked</h3>
                                <div class="alert alert-info">
                                    <strong>Exact question text:</strong><br>
                                    "How would you help advance the President's Executive Orders and policy priorities in this role?"
                                </div>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col-12">
                                <h3>Data Coverage</h3>
                                <p id="dataCoverage"></p>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col-12">
                                <hr>
                                <div class="text-center">
                                    <p class="mb-3">Created by Abigail Haddad</p>
                                    <div class="d-flex justify-content-center gap-3">
                                        <a href="https://github.com/abigailhaddad/usajobs_historical" target="_blank" class="btn btn-outline-dark">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-github me-2" viewBox="0 0 16 16">
                                                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                                            </svg>
                                            GitHub
                                        </a>
                                        <a href="https://www.linkedin.com/in/abigail-haddad/" target="_blank" class="btn btn-outline-primary">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-linkedin me-2" viewBox="0 0 16 16">
                                                <path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"/>
                                            </svg>
                                            LinkedIn
                                        </a>
                                        <a href="https://presentofcoding.substack.com/" target="_blank" class="btn btn-outline-success">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square me-2" viewBox="0 0 16 16">
                                                <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                                                <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
                                            </svg>
                                            Substack
                                        </a>
                                        <a href="mailto:abigailhaddad@gmail.com" class="btn btn-outline-secondary">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-envelope me-2" viewBox="0 0 16 16">
                                                <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/>
                                            </svg>
                                            Contact
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Service Type Tab -->
                    <div class="tab-pane fade" id="service" role="tabpanel">
                        <h3>Service Type Analysis</h3>
                        <div id="serviceTable"></div>
                    </div>
                    
                    <!-- Grade Level Tab -->
                    <div class="tab-pane fade" id="grade" role="tabpanel">
                        <h3>Grade Level Analysis (Top 10)</h3>
                        <div id="gradeTable"></div>
                    </div>
                    
                    <!-- Location Tab -->
                    <div class="tab-pane fade" id="location" role="tabpanel">
                        <h3>Geographic Analysis (Top 10)</h3>
                        <div id="locationTable"></div>
                    </div>
                    
                    <!-- Agency Tab -->
                    <div class="tab-pane fade" id="agency" role="tabpanel">
                        <h3>Agency Analysis (Top 20)</h3>
                        <div id="agencyTable"></div>
                    </div>
                    
                    <!-- Occupation Tab -->
                    <div class="tab-pane fade" id="occupation" role="tabpanel">
                        <h3>Occupation Series Analysis (Top 20)</h3>
                        <div id="occupationTable"></div>
                    </div>
                    
                    <!-- Timeline Tab -->
                    <div class="tab-pane fade" id="timeline" role="tabpanel">
                        <h3>Essay Question Usage by Job Opening Date</h3>
                        <p>Weekly and monthly percentages of jobs posted with the essay question</p>
                        <div id="timelineTable"></div>
                    </div>
                    
                    <!-- Jobs Tab -->
                    <div class="tab-pane fade" id="jobs" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>Job Listings with New Essay Question</h3>
                            <button id="downloadCSV" class="btn btn-primary">Download All as CSV</button>
                        </div>
                        <div class="mb-3">
                            <p>Showing <span id="jobsShown">0</span> of <span id="jobsTotal">0</span> jobs</p>
                            <small class="text-muted">Tip: Press Enter to add a search term as a filter. Add multiple filters per column.</small>
                            <div id="activeFilters" class="d-flex flex-wrap gap-2 mt-2"></div>
                        </div>
                        <table id="jobsTable" class="table table-striped table-bordered" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Position Title</th>
                                    <th>Occupation</th>
                                    <th>Agency</th>
                                    <th>Location</th>
                                    <th>Grade</th>
                                    <th>Service</th>
                                    <th>Open</th>
                                    <th>Close</th>
                                    <th>USAJobs</th>
                                    <th>Questions</th>
                                </tr>
                                <tr class="search-row">
                                    <th><input type="text" class="form-control form-control-sm column-search" data-column="0" placeholder="Search title..." /></th>
                                    <th><input type="text" class="form-control form-control-sm column-search" data-column="1" placeholder="Search occupation..." /></th>
                                    <th><input type="text" class="form-control form-control-sm column-search" data-column="2" placeholder="Search agency..." /></th>
                                    <th><input type="text" class="form-control form-control-sm column-search" data-column="3" placeholder="Search location..." /></th>
                                    <th>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown">
                                                All Grades
                                            </button>
                                            <div class="dropdown-menu p-2 grade-dropdown" style="min-width: 200px; max-height: 400px; overflow-y: auto;">
                                                <!-- Grade checkboxes will be populated here -->
                                            </div>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown">
                                                All Services
                                            </button>
                                            <div class="dropdown-menu p-2" style="min-width: 200px;">
                                                <div class="form-check">
                                                    <input class="form-check-input service-filter" type="checkbox" value="Competitive" id="serviceCompetitive">
                                                    <label class="form-check-label" for="serviceCompetitive">Competitive</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input service-filter" type="checkbox" value="Excepted" id="serviceExcepted">
                                                    <label class="form-check-label" for="serviceExcepted">Excepted</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input service-filter" type="checkbox" value="Senior Executive" id="serviceSenior">
                                                    <label class="form-check-label" for="serviceSenior">Senior Executive</label>
                                                </div>
                                            </div>
                                        </div>
                                    </th>
                                    <th><input type="text" class="form-control form-control-sm column-search" data-column="6" placeholder="Search date..." /></th>
                                    <th><input type="text" class="form-control form-control-sm column-search" data-column="7" placeholder="Search date..." /></th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    
    <script>
        // Load data from JSON files
        async function loadData() {
            try {
                const response = await fetch('analysis_data.json');
                const data = await response.json();
                
                // Populate overview
                document.getElementById('totalScraped').textContent = data.overview.total_scraped.toLocaleString();
                document.getElementById('totalWithEO').textContent = data.overview.total_with_eo.toLocaleString();
                document.getElementById('percentageWithEO').textContent = data.overview.percentage_with_eo + '%';
                document.getElementById('dataCoverage').textContent = data.overview.data_coverage;
                
                // Create simple tables for analyses
                createSimpleTable('serviceTable', data.service_analysis);
                createSimpleTable('gradeTable', data.grade_analysis);
                createSimpleTable('locationTable', data.location_analysis);
                createSimpleTable('agencyTable', data.agency_analysis);
                createSimpleTable('occupationTable', data.occupation_analysis);
                
                // Create timeline heatmap
                createTimelineTable('timelineTable', data.timeline_analysis);
                
                // Initialize DataTable for jobs
                initJobsTable(data.job_postings);
                
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
        
        function createSimpleTable(elementId, data) {
            const container = document.getElementById(elementId);
            const table = document.createElement('table');
            table.className = 'table table-bordered';
            
            // Find max percentage for scaling
            let maxPercent = 0;
            data.forEach(row => {
                Object.entries(row).forEach(([key, value]) => {
                    if (key.includes('Percentage')) {
                        const percent = parseFloat(value);
                        if (percent > maxPercent) maxPercent = percent;
                    }
                });
            });
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            Object.keys(data[0]).forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            data.forEach(row => {
                const tr = document.createElement('tr');
                Object.values(row).forEach((value, index) => {
                    const td = document.createElement('td');
                    const columnKey = Object.keys(row)[index];
                    
                    // Add % sign to percentage columns
                    if (columnKey.includes('Percentage')) {
                        td.textContent = value + '%';
                        td.style.textAlign = 'center';
                        const percent = parseFloat(value);
                        // Scale to max percent in this table
                        const intensity = maxPercent > 0 ? percent / maxPercent : 0;
                        td.style.backgroundColor = `rgba(13, 110, 253, ${intensity})`;
                        td.style.color = intensity > 0.5 ? 'white' : 'black';
                    } else {
                        // Format numbers with commas
                        if (typeof value === 'number' && !columnKey.includes('Percentage')) {
                            td.textContent = value.toLocaleString();
                            td.style.textAlign = 'center';
                        } else {
                            td.textContent = value;
                        }
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            
            container.appendChild(table);
        }
        
        function createTimelineTable(elementId, data) {
            const container = document.getElementById(elementId);
            const table = document.createElement('table');
            table.className = 'table table-bordered heatmap-table';
            
            // Find max percentage for scaling
            let maxPercent = 0;
            data.forEach(row => {
                ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Monthly Percentage'].forEach(key => {
                    if (row[key] !== null && row[key] !== undefined) {
                        const percent = parseFloat(row[key]);
                        if (percent > maxPercent) maxPercent = percent;
                    }
                });
            });
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            ['Month', 'Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Monthly Percentage', 'Total Jobs Posted', 'Jobs with Essay Question'].forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            data.forEach(row => {
                const tr = document.createElement('tr');
                Object.entries(row).forEach(([key, value]) => {
                    const td = document.createElement('td');
                    if (key.includes('Week') || key === 'Monthly Percentage') {
                        if (value !== null) {
                            td.textContent = value + '%';
                            const percent = parseFloat(value);
                            // Scale to max percent in this table
                            const intensity = maxPercent > 0 ? percent / maxPercent : 0;
                            td.style.backgroundColor = `rgba(13, 110, 253, ${intensity})`;
                            td.style.color = intensity > 0.5 ? 'white' : 'black';
                        } else {
                            td.textContent = '—';
                            td.style.backgroundColor = '#f0f0f0';
                        }
                    } else {
                        // Format numbers with commas
                        if (typeof value === 'number') {
                            td.textContent = value.toLocaleString();
                        } else {
                            td.textContent = value;
                        }
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            
            container.appendChild(table);
        }
        
        let allJobsData = []; // Store all jobs data for CSV download
        
        function initJobsTable(data) {
            allJobsData = data; // Store for CSV download
            
            // Update counts
            document.getElementById('jobsTotal').textContent = data.length;
            document.getElementById('jobsShown').textContent = Math.min(50, data.length);
            
            const table = $('#jobsTable').DataTable({
                data: data,
                columns: [
                    { data: 'position_title' },
                    { data: 'occupation' },
                    { data: 'agency' },
                    { data: 'location' },
                    { data: 'grade' },
                    { data: 'service' },
                    { data: 'open_date' },
                    { data: 'close_date' },
                    { 
                        data: 'usajobs_link',
                        render: function(data, type, row) {
                            if (type === 'export') {
                                return data ? 'https://www.usajobs.gov/job/' + data : '';
                            }
                            if (data) {
                                return '<a href="https://www.usajobs.gov/job/' + data + '" target="_blank">View Job</a>';
                            }
                            return '';
                        }
                    },
                    { 
                        data: 'questionnaire_link',
                        render: function(data, type, row) {
                            if (type === 'export') {
                                return data || '';
                            }
                            if (data) {
                                return '<a href="' + data + '" target="_blank">View Questions</a>';
                            }
                            return '';
                        }
                    }
                ],
                pageLength: 50,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                scrollX: false,
                searching: true,
                dom: 'lfrtip',
                orderCellsTop: true,
                fixedHeader: true,
                drawCallback: function() {
                    // Update shown count when page changes
                    const info = this.api().page.info();
                    document.getElementById('jobsShown').textContent = info.end;
                },
                initComplete: function() {
                    // Setup column search
                    const api = this.api();
                    const columnNames = ['Position Title', 'Occupation', 'Agency', 'Location', 'Grade', 'Service', 'Open Date', 'Close Date'];
                    
                    // Store active filters for each column
                    const columnFilters = {
                        0: [], 1: [], 2: [], 3: [], 6: [], 7: []
                    };
                    
                    // Populate grade dropdown with checkboxes
                    const gradeDropdown = $('.grade-dropdown');
                    const uniqueGrades = [...new Set(allJobsData.map(job => job.grade))].sort();
                    uniqueGrades.forEach((grade, index) => {
                        if (grade) {
                            gradeDropdown.append(`
                                <div class="form-check">
                                    <input class="form-check-input grade-filter" type="checkbox" value="${grade}" id="grade${index}">
                                    <label class="form-check-label" for="grade${index}">${grade}</label>
                                </div>
                            `);
                        }
                    });
                    
                    // Function to update filter display
                    function updateFilterDisplay() {
                        const filterContainer = document.getElementById('activeFilters');
                        filterContainer.innerHTML = '';
                        
                        let hasFilters = false;
                        
                        // Show text search filters
                        Object.entries(columnFilters).forEach(([colIdx, filters]) => {
                            if (filters.length > 0) {
                                hasFilters = true;
                                filters.forEach((filter, index) => {
                                    const filterTag = document.createElement('div');
                                    filterTag.className = 'filter-tag';
                                    filterTag.innerHTML = `
                                        <span><strong>${columnNames[colIdx]}:</strong> "${filter}"</span>
                                        <span class="remove-filter" data-column="${colIdx}" data-index="${index}" title="Remove filter">×</span>
                                    `;
                                    filterContainer.appendChild(filterTag);
                                });
                            }
                        });
                        
                        // Show grade filters
                        const checkedGrades = $('.grade-filter:checked').map(function() {
                            return $(this).val();
                        }).get();
                        if (checkedGrades.length > 0) {
                            hasFilters = true;
                            const filterTag = document.createElement('div');
                            filterTag.className = 'filter-tag';
                            filterTag.innerHTML = `
                                <span><strong>${columnNames[4]}:</strong> ${checkedGrades.join(', ')}</span>
                                <span class="remove-filter" data-column="4" title="Remove filter">×</span>
                            `;
                            filterContainer.appendChild(filterTag);
                        }
                        
                        // Show service filters
                        const checkedServices = $('.service-filter:checked').map(function() {
                            return $(this).val();
                        }).get();
                        if (checkedServices.length > 0) {
                            hasFilters = true;
                            const filterTag = document.createElement('div');
                            filterTag.className = 'filter-tag';
                            filterTag.innerHTML = `
                                <span><strong>${columnNames[5]}:</strong> ${checkedServices.join(', ')}</span>
                                <span class="remove-filter" data-column="5" title="Remove filter">×</span>
                            `;
                            filterContainer.appendChild(filterTag);
                        }
                        
                        if (!hasFilters) {
                            filterContainer.innerHTML = '<small class="text-muted">No filters applied</small>';
                        }
                    }
                    
                    // Function to apply column filters
                    function applyColumnFilter(colIdx) {
                        const filters = columnFilters[colIdx];
                        if (filters && filters.length > 0) {
                            // Create regex pattern for OR search
                            const pattern = filters.map(term => term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|');
                            api.column(colIdx).search(pattern, true, false).draw();
                        } else {
                            api.column(colIdx).search('').draw();
                        }
                    }
                    
                    // Apply the search on text inputs
                    $('.column-search').on('keyup change clear', function(e) {
                        const colIdx = parseInt($(this).data('column'));
                        const searchValue = this.value.trim();
                        
                        // On Enter key, add to filters
                        if (e.type === 'keyup' && e.keyCode === 13) {
                            if (searchValue && !columnFilters[colIdx].includes(searchValue)) {
                                columnFilters[colIdx].push(searchValue);
                                this.value = ''; // Clear input
                                applyColumnFilter(colIdx);
                                updateFilterDisplay();
                            }
                            return;
                        }
                        
                        // For clear event, reset filters
                        if (e.type === 'clear') {
                            columnFilters[colIdx] = [];
                            applyColumnFilter(colIdx);
                            updateFilterDisplay();
                        }
                    });
                    
                    // Handle grade checkboxes
                    $('.grade-filter').on('change', function() {
                        const checkedGrades = $('.grade-filter:checked').map(function() {
                            return $(this).val();
                        }).get();
                        
                        // Update button text
                        const button = $('.grade-dropdown').closest('.dropdown').find('button');
                        if (checkedGrades.length === 0) {
                            button.text('All Grades');
                        } else if (checkedGrades.length === 1) {
                            button.text(checkedGrades[0]);
                        } else {
                            button.text(checkedGrades.length + ' Grades Selected');
                        }
                        
                        if (checkedGrades.length > 0) {
                            const pattern = '^(' + checkedGrades.map(g => g.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|') + ')$';
                            api.column(4).search(pattern, true, false).draw();
                        } else {
                            api.column(4).search('').draw();
                        }
                        updateFilterDisplay();
                    });
                    
                    // Handle service checkboxes
                    $('.service-filter').on('change', function() {
                        const checkedServices = $('.service-filter:checked').map(function() {
                            return $(this).val();
                        }).get();
                        
                        // Update button text
                        const button = $(this).closest('.dropdown').find('button');
                        if (checkedServices.length === 0) {
                            button.text('All Services');
                        } else if (checkedServices.length === 1) {
                            button.text(checkedServices[0]);
                        } else {
                            button.text(checkedServices.length + ' Selected');
                        }
                        
                        if (checkedServices.length > 0) {
                            const pattern = '^(' + checkedServices.join('|') + ')$';
                            api.column(5).search(pattern, true, false).draw();
                        } else {
                            api.column(5).search('').draw();
                        }
                        updateFilterDisplay();
                    });
                    
                    // Handle filter removal
                    $(document).on('click', '.remove-filter', function() {
                        const colIdx = parseInt($(this).data('column'));
                        const filterIndex = $(this).data('index');
                        
                        if (colIdx === 4) {
                            // Clear grade checkboxes
                            $('.grade-filter').prop('checked', false);
                            $('.grade-dropdown').closest('.dropdown').find('button').text('All Grades');
                            api.column(4).search('').draw();
                        } else if (colIdx === 5) {
                            // Clear service checkboxes
                            $('.service-filter').prop('checked', false);
                            $('.service-dropdown').closest('.dropdown').find('button').text('All Services');
                            api.column(5).search('').draw();
                        } else {
                            // Remove specific text filter
                            if (filterIndex !== undefined) {
                                columnFilters[colIdx].splice(filterIndex, 1);
                                applyColumnFilter(colIdx);
                            }
                        }
                        updateFilterDisplay();
                    });
                    
                    // Prevent sorting when clicking on search inputs
                    $('.search-row input, .search-row select, .search-row .dropdown').on('click', function(e) {
                        e.stopPropagation();
                    });
                    
                    // Keep dropdowns open when clicking inside
                    $('.dropdown-menu').on('click', function(e) {
                        e.stopPropagation();
                    });
                    
                    // Initial display
                    updateFilterDisplay();
                }
            });
        }
        
        // CSV download function
        function downloadCSV() {
            const headers = ['Position Title', 'Occupation', 'Agency', 'Location', 'Grade', 'Service Type', 'Open Date', 'Close Date', 'USAJobs Link', 'Questionnaire Link'];
            const csvContent = [
                headers.join(','),
                ...allJobsData.map(row => {
                    return [
                        '"' + (row.position_title || '').replace(/"/g, '""') + '"',
                        '"' + (row.occupation || '').replace(/"/g, '""') + '"',
                        '"' + (row.agency || '').replace(/"/g, '""') + '"',
                        '"' + (row.location || '').replace(/"/g, '""') + '"',
                        '"' + (row.grade || '').replace(/"/g, '""') + '"',
                        '"' + (row.service || '').replace(/"/g, '""') + '"',
                        row.open_date || '',
                        row.close_date || '',
                        row.usajobs_link ? 'https://www.usajobs.gov/job/' + row.usajobs_link : '',
                        row.questionnaire_link || ''
                    ].join(',');
                })
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'executive_order_jobs.csv';
            link.click();
        }
        
        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // Add event listener for CSV download button
            document.getElementById('downloadCSV').addEventListener('click', downloadCSV);
        });
    </script>
</body>
</html>