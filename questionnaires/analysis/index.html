<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merit Hiring Plan Essay Tracker</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DDF6Y1ESED"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-DDF6Y1ESED');
    </script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container-fluid {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #2c3e50;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        .tab-content {
            padding: 30px 0;
        }
        .stats-card {
            margin-bottom: 20px;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        .stats-card .card-title {
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stats-card h2 {
            font-weight: 700;
            margin-top: 10px;
        }
        .heatmap-table td {
            text-align: center;
            padding: 8px;
        }
        .heatmap-cell {
            background: linear-gradient(to right, #ffffff var(--percent), #0d6efd var(--percent));
        }
        .dataTables_filter {
            display: none;
        }
        tfoot input {
            width: 100%;
            padding: 3px;
            box-sizing: border-box;
        }
        .search-row th {
            padding: 4px !important;
        }
        .search-row input {
            font-weight: normal;
        }
        .filter-tag {
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        .filter-tag .remove-filter {
            cursor: pointer;
            color: #6c757d;
            font-weight: bold;
            margin-left: 0.25rem;
        }
        .filter-tag .remove-filter:hover {
            color: #dc3545;
        }
        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
        }
        .nav-tabs .nav-link {
            color: #6c757d;
            font-weight: 500;
            border: none;
            border-bottom: 3px solid transparent;
            padding: 0.75rem 1.5rem;
            transition: all 0.2s;
        }
        .nav-tabs .nav-link:hover {
            border-color: transparent;
            color: #495057;
        }
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            background-color: transparent;
            border-color: transparent;
            border-bottom-color: #0d6efd;
        }
        .table {
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        }
        .alert-info {
            background-color: #e3f2fd;
            border-color: #bbdefb;
            color: #1565c0;
        }
        .question-highlight {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        .question-highlight h4 {
            color: #856404;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }
        .question-text {
            font-size: 1.1rem;
            font-style: italic;
            color: #495057;
            line-height: 1.6;
        }
        .show-all-btn {
            margin-top: 15px;
            font-size: 0.9rem;
        }
        .table-container {
            position: relative;
        }
        h3 {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px;
        }
        .sortable:hover {
            background-color: #f0f0f0;
        }
        .sortable::after {
            content: '↕';
            position: absolute;
            right: 5px;
            color: #ccc;
            font-size: 12px;
        }
        .sortable.asc::after {
            content: '↑';
            color: #0d6efd;
        }
        .sortable.desc::after {
            content: '↓';
            color: #0d6efd;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 class="mt-5 mb-4 text-center">"Merit Hiring Plan" Essay Tracker</h1>
                <p class="text-center text-muted mb-5">Tracking the implementation of new essay questions in federal job applications</p>
                
                <!-- Tabs -->
                <ul class="nav nav-tabs" id="analysisTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">Overview</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="service-tab" data-bs-toggle="tab" data-bs-target="#service" type="button">By Service Type</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="grade-tab" data-bs-toggle="tab" data-bs-target="#grade" type="button">By Grade Level</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="location-tab" data-bs-toggle="tab" data-bs-target="#location" type="button">By Location</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="agency-tab" data-bs-toggle="tab" data-bs-target="#agency" type="button">By Agency</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="occupation-tab" data-bs-toggle="tab" data-bs-target="#occupation" type="button">By Occupation</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline" type="button">Timeline</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="jobs-tab" data-bs-toggle="tab" data-bs-target="#jobs" type="button">Job Listings</button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content" id="analysisTabContent">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card stats-card">
                                    <div class="card-body">
                                        <h5 class="card-title">Total Scraped Questionnaires</h5>
                                        <h2 class="text-primary" id="totalScraped">-</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card stats-card">
                                    <div class="card-body">
                                        <h5 class="card-title">With Essay Question</h5>
                                        <h2 class="text-success" id="totalWithEO">-</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card stats-card">
                                    <div class="card-body">
                                        <h5 class="card-title">Percentage</h5>
                                        <h2 class="text-info" id="percentageWithEO">-</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-5">
                            <div class="col-12">
                                <div class="card mb-4">
                                    <div class="card-header bg-primary text-white">
                                        <h4 class="mb-0">Essay Questions</h4>
                                    </div>
                                    <div class="card-body">
                                        <p class="mb-4">The <a href="https://www.dcpas.osd.mil/sites/default/files/2025-05/Merit%20Hiring%20Plan%205-29-2025.pdf" target="_blank">Merit Hiring Plan</a> requires applicants for GS-5 and above positions to answer these four essay questions (200 words max each):</p>
                                        
                                        <div class="accordion" id="essayQuestions">
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#question1">
                                                        <strong>1. Commitment to the Constitution</strong>
                                                    </button>
                                                </h2>
                                                <div id="question1" class="accordion-collapse collapse" data-bs-parent="#essayQuestions">
                                                    <div class="accordion-body">
                                                        "How has your commitment to the Constitution and the founding principles of the United States inspired you to pursue this role within the Federal government? Provide a concrete example from professional, academic, or personal experience."
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#question2">
                                                        <strong>2. Government Efficiency</strong>
                                                    </button>
                                                </h2>
                                                <div id="question2" class="accordion-collapse collapse" data-bs-parent="#essayQuestions">
                                                    <div class="accordion-body">
                                                        "In this role, how would you use your skills and experience to improve government efficiency and effectiveness? Provide specific examples where you improved processes, reduced costs, or improved outcomes."
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#question3">
                                                        <strong>3. Executive Orders and Policy Priorities</strong>
                                                    </button>
                                                </h2>
                                                <div id="question3" class="accordion-collapse collapse" data-bs-parent="#essayQuestions">
                                                    <div class="accordion-body">
                                                        "How would you help advance the President's Executive Orders and policy priorities in this role? Identify one or two relevant Executive Orders or policy initiatives that are significant to you, and explain how you would help implement them if hired."
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#question4">
                                                        <strong>4. Work Ethic</strong>
                                                    </button>
                                                </h2>
                                                <div id="question4" class="accordion-collapse collapse" data-bs-parent="#essayQuestions">
                                                    <div class="accordion-body">
                                                        "How has a strong work ethic contributed to your professional, academic or personal achievements? Provide one or two specific examples, and explain how those qualities would enable you to serve effectively in this position."
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <p class="text-muted small mb-0 mt-3"><strong>Technical note:</strong> This tracker identifies job postings containing these essay questions by searching questionnaire files for the text: <code style="background-color: #f8f9fa; padding: 2px 4px; border-radius: 3px;">How would you help advance the President's Executive Orders and policy priorities in this role?</code></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-5">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h4 class="mb-0">Data Coverage & Methodology</h4>
                                    </div>
                                    <div class="card-body">
                                        <p class="mb-3" id="dataCoverage"></p>
                                        
                                        <h6 class="text-muted mb-2">Understanding the Statistics</h6>
                                        <ul class="small mb-0">
                                            <li><strong>Total Jobs:</strong> All federal job postings in each category</li>
                                            <li><strong>Scraped Questionnaires:</strong> Jobs where we successfully downloaded the questionnaire</li>
                                            <li><strong>Jobs with Essay Questions:</strong> Jobs containing the Merit Hiring Plan questions</li>
                                            <li><strong>% of Scraped:</strong> Percentage of successfully scraped questionnaires containing the essay questions</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-5 pt-5 border-top">
                            <div class="col-12">
                                <div class="text-center">
                                    <p class="mb-3">Created by Abigail Haddad</p>
                                    <div class="d-flex justify-content-center gap-3">
                                        <a href="https://abigailhaddad.netlify.app/" target="_blank" class="btn btn-outline-info">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-globe me-2" viewBox="0 0 16 16">
                                                <path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm7.5-6.923c-.67.204-1.335.82-1.887 1.855A7.97 7.97 0 0 0 5.145 4H7.5V1.077zM4.09 4a9.267 9.267 0 0 1 .64-1.539 6.7 6.7 0 0 1 .597-.933A7.025 7.025 0 0 0 2.255 4H4.09zm-.582 3.5c.03-.877.138-1.718.312-2.5H1.674a6.958 6.958 0 0 0-.656 2.5h2.49zM4.847 5a12.5 12.5 0 0 0-.338 2.5H7.5V5H4.847zM8.5 5v2.5h2.99a12.495 12.495 0 0 0-.337-2.5H8.5zM4.51 8.5a12.5 12.5 0 0 0 .337 2.5H7.5V8.5H4.51zm3.99 0V11h2.653c.187-.765.306-1.608.338-2.5H8.5zM5.145 12c.138.386.295.744.468 1.068.552 1.035 1.218 1.65 1.887 1.855V12H5.145zm.182 2.472a6.696 6.696 0 0 1-.597-.933A9.268 9.268 0 0 1 4.09 12H2.255a7.024 7.024 0 0 0 3.072 2.472zM3.82 11a13.652 13.652 0 0 1-.312-2.5h-2.49c.062.89.291 1.733.656 2.5H3.82zm6.853 3.472A7.024 7.024 0 0 0 13.745 12H11.91a9.27 9.27 0 0 1-.64 1.539 6.688 6.688 0 0 1-.597.933zM8.5 12v2.923c.67-.204 1.335-.82 1.887-1.855.173-.324.33-.682.468-1.068H8.5zm3.68-1h2.146c.365-.767.594-1.61.656-2.5h-2.49a13.65 13.65 0 0 1-.312 2.5zm2.802-3.5a6.959 6.959 0 0 0-.656-2.5H12.18c.174.782.282 1.623.312 2.5h2.49zM11.27 2.461c.247.464.462.98.64 1.539h1.835a7.024 7.024 0 0 0-3.072-2.472c.218.284.418.598.597.933zM10.855 4a7.966 7.966 0 0 0-.468-1.068C9.835 1.897 9.17 1.282 8.5 1.077V4h2.355z"/>
                                            </svg>
                                            Website
                                        </a>
                                        <a href="https://github.com/abigailhaddad/usajobs_historical" target="_blank" class="btn btn-outline-dark">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-github me-2" viewBox="0 0 16 16">
                                                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                                            </svg>
                                            GitHub
                                        </a>
                                        <a href="https://www.linkedin.com/in/abigail-haddad/" target="_blank" class="btn btn-outline-primary">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-linkedin me-2" viewBox="0 0 16 16">
                                                <path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"/>
                                            </svg>
                                            LinkedIn
                                        </a>
                                        <a href="https://presentofcoding.substack.com/" target="_blank" class="btn btn-outline-success">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square me-2" viewBox="0 0 16 16">
                                                <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                                                <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
                                            </svg>
                                            Substack
                                        </a>
                                        <a href="mailto:abigailhaddad@gmail.com" class="btn btn-outline-secondary">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-envelope me-2" viewBox="0 0 16 16">
                                                <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/>
                                            </svg>
                                            Contact
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Service Type Tab -->
                    <div class="tab-pane fade" id="service" role="tabpanel">
                        <div class="section-header">
                            <h3>Service Type Analysis</h3>
                            <button class="btn btn-outline-primary show-all-btn" data-table="serviceTable" style="display: none;">Show All</button>
                        </div>
                        <div class="table-container">
                            <div id="serviceTable"></div>
                        </div>
                    </div>
                    
                    <!-- Grade Level Tab -->
                    <div class="tab-pane fade" id="grade" role="tabpanel">
                        <div class="section-header">
                            <h3>Grade Level Analysis</h3>
                            <button class="btn btn-outline-primary show-all-btn" data-table="gradeTable">Show All Grades</button>
                        </div>
                        <div class="table-container">
                            <div id="gradeTable"></div>
                        </div>
                    </div>
                    
                    <!-- Location Tab -->
                    <div class="tab-pane fade" id="location" role="tabpanel">
                        <div class="section-header">
                            <h3>Geographic Analysis</h3>
                            <button class="btn btn-outline-primary show-all-btn" data-table="locationTable">Show All Locations</button>
                        </div>
                        <div class="table-container">
                            <div id="locationTable"></div>
                        </div>
                    </div>
                    
                    <!-- Agency Tab -->
                    <div class="tab-pane fade" id="agency" role="tabpanel">
                        <div class="section-header">
                            <h3>Agency Analysis</h3>
                            <button class="btn btn-outline-primary show-all-btn" data-table="agencyTable">Show All Agencies</button>
                        </div>
                        <div class="table-container">
                            <div id="agencyTable"></div>
                        </div>
                    </div>
                    
                    <!-- Occupation Tab -->
                    <div class="tab-pane fade" id="occupation" role="tabpanel">
                        <div class="section-header">
                            <h3>Occupation Series Analysis</h3>
                            <button class="btn btn-outline-primary show-all-btn" data-table="occupationTable">Show All Occupations</button>
                        </div>
                        <div class="table-container">
                            <div id="occupationTable"></div>
                        </div>
                    </div>
                    
                    <!-- Timeline Tab -->
                    <div class="tab-pane fade" id="timeline" role="tabpanel">
                        <h3>Essay Question Usage by Job Opening Date</h3>
                        <p>Weekly and monthly percentages of jobs posted with the essay question</p>
                        <div class="alert alert-info">
                            <strong>Note:</strong> Percentages shown represent the portion of <em>scraped questionnaires</em> that contain the essay question for each time period. The "Total Jobs Posted" column shows the number of questionnaires we analyzed.
                        </div>
                        <div id="timelineTable"></div>
                    </div>
                    
                    <!-- Jobs Tab -->
                    <div class="tab-pane fade" id="jobs" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>Job Listings with New Essay Question</h3>
                            <button id="downloadCSV" class="btn btn-primary">Download All as CSV</button>
                        </div>
                        <div class="alert alert-warning" role="alert">
                            <strong>Important Notes:</strong>
                            <ul class="mb-0">
                                <li>This table now shows ALL federal jobs from our dataset, not just those with the essay question</li>
                                <li>We only scrape questionnaires from USAStaffing and Monster Government sites</li>
                                <li>Other agencies (e.g., FAA, Intelligence Community) may have questionnaires on their own sites that are not included</li>
                            </ul>
                        </div>
                        <div class="mb-3">
                            <p>Showing <span id="jobsShown">0</span> of <span id="jobsTotal">0</span> jobs</p>
                            <small class="text-muted">Tip: Press Enter to add a search term as a filter. Add multiple filters per column.</small>
                            <div id="activeFilters" class="d-flex flex-wrap gap-2 mt-2"></div>
                        </div>
                        <table id="jobsTable" class="table table-striped table-bordered" style="width:100%">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Position Title</th>
                                    <th>Occupation</th>
                                    <th>Agency</th>
                                    <th>Location</th>
                                    <th>Grade</th>
                                    <th>Service</th>
                                    <th>Open</th>
                                    <th>Close</th>
                                    <th>Questionnaire Status</th>
                                    <th>USAJobs</th>
                                    <th>Questions</th>
                                </tr>
                                <tr class="search-row">
                                    <th><input type="text" class="form-control form-control-sm column-search" data-column="0" placeholder="Search ID..." /></th>
                                    <th><input type="text" class="form-control form-control-sm column-search" data-column="1" placeholder="Search title..." /></th>
                                    <th><input type="text" class="form-control form-control-sm column-search" data-column="2" placeholder="Search occupation..." /></th>
                                    <th><input type="text" class="form-control form-control-sm column-search" data-column="3" placeholder="Search agency..." /></th>
                                    <th><input type="text" class="form-control form-control-sm column-search" data-column="4" placeholder="Search location..." /></th>
                                    <th>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown">
                                                All Grades
                                            </button>
                                            <div class="dropdown-menu p-2 grade-dropdown" style="min-width: 200px; max-height: 400px; overflow-y: auto;">
                                                <!-- Grade checkboxes will be populated here -->
                                            </div>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown">
                                                All Services
                                            </button>
                                            <div class="dropdown-menu p-2" style="min-width: 200px;">
                                                <div class="form-check">
                                                    <input class="form-check-input service-filter" type="checkbox" value="Competitive" id="serviceCompetitive">
                                                    <label class="form-check-label" for="serviceCompetitive">Competitive</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input service-filter" type="checkbox" value="Excepted" id="serviceExcepted">
                                                    <label class="form-check-label" for="serviceExcepted">Excepted</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input service-filter" type="checkbox" value="Senior Executive" id="serviceSenior">
                                                    <label class="form-check-label" for="serviceSenior">Senior Executive</label>
                                                </div>
                                            </div>
                                        </div>
                                    </th>
                                    <th><input type="text" class="form-control form-control-sm column-search" data-column="7" placeholder="Search date..." /></th>
                                    <th><input type="text" class="form-control form-control-sm column-search" data-column="8" placeholder="Search date..." /></th>
                                    <th>
                                        <select class="form-select form-select-sm" id="statusFilter">
                                            <option value="">All statuses</option>
                                            <option value="No questionnaire">No questionnaire detected</option>
                                            <option value="Has questionnaire (not scraped)">Has questionnaire (not scraped)</option>
                                            <option value="Questionnaire without EO question">Questionnaire scraped (no EO question)</option>
                                            <option value="Questionnaire with EO question">Questionnaire with EO question ✓</option>
                                        </select>
                                    </th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    
    <script>
        // Load data from JSON files
        async function loadData() {
            try {
                const response = await fetch('analysis_data.json');
                const data = await response.json();
                
                // Populate overview
                document.getElementById('totalScraped').textContent = data.overview.total_jobs_with_questionnaires.toLocaleString();
                document.getElementById('totalWithEO').textContent = data.overview.total_jobs_with_eo.toLocaleString();
                document.getElementById('percentageWithEO').textContent = data.overview.percentage_with_eo + '%';
                document.getElementById('dataCoverage').textContent = data.overview.data_coverage;
                
                
                // Create simple tables for analyses
                createSimpleTable('serviceTable', data.service_analysis);
                createSimpleTable('gradeTable', data.grade_analysis);
                createSimpleTable('locationTable', data.location_analysis);
                createSimpleTable('agencyTable', data.agency_analysis);
                createSimpleTable('occupationTable', data.occupation_analysis);
                
                // Create timeline heatmap
                createTimelineTable('timelineTable', data.timeline_analysis);
                
                // Initialize DataTable for jobs
                initJobsTable(data.job_postings);
                
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
        
        function createSimpleTable(elementId, data) {
            const container = document.getElementById(elementId);
            const table = document.createElement('table');
            table.className = 'table table-striped table-bordered table-hover';
            
            // Store original data for sorting
            let tableData = [...data];
            let currentSort = { column: null, direction: null };
            
            // Determine initial row limit based on table type
            const initialLimits = {
                'gradeTable': 10,
                'locationTable': 10,
                'agencyTable': 20,
                'occupationTable': 20,
                'serviceTable': 999  // Show all for service table (usually small)
            };
            const initialLimit = initialLimits[elementId] || 10;
            
            // Function to render table body
            function renderTableBody() {
                // Clear existing tbody if any
                const existingTbody = table.querySelector('tbody');
                if (existingTbody) {
                    existingTbody.remove();
                }
                
                // Find max percentage for scaling
                let maxPercent = 0;
                tableData.forEach(row => {
                    Object.entries(row).forEach(([key, value]) => {
                        if (key.includes('%')) {
                            const percent = parseFloat(value);
                            if (percent > maxPercent) maxPercent = percent;
                        }
                    });
                });
                
                // Create body
                const tbody = document.createElement('tbody');
                tableData.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    if (index >= initialLimit) {
                        tr.style.display = 'none';
                        tr.className = 'hidden-row';
                    }
                    Object.values(row).forEach((value, index) => {
                        const td = document.createElement('td');
                        const columnKey = Object.keys(row)[index];
                        
                        // Add % sign to percentage columns
                        if (columnKey.includes('% of Scraped')) {
                            td.textContent = value + '%';
                            td.style.textAlign = 'center';
                            const percent = parseFloat(value);
                            // Scale to max percent in this table
                            const intensity = maxPercent > 0 ? percent / maxPercent : 0;
                            td.style.backgroundColor = `rgba(13, 110, 253, ${intensity})`;
                            td.style.color = intensity > 0.5 ? 'white' : 'black';
                        } else {
                            // Format numbers with commas
                            if (typeof value === 'number' && !columnKey.includes('% of Scraped')) {
                                td.textContent = value.toLocaleString();
                                td.style.textAlign = 'center';
                            } else {
                                td.textContent = value;
                            }
                        }
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
                
                // Add totals row
                const totalsRow = document.createElement('tr');
                totalsRow.className = 'table-info font-weight-bold';
                totalsRow.style.fontWeight = 'bold';
                
                // Calculate totals
                const totals = {};
                columnKeys.forEach((key, index) => {
                    if (index === 0) {
                        totals[key] = 'TOTAL';
                    } else if (typeof tableData[0][key] === 'number' && !key.includes('%')) {
                        totals[key] = tableData.reduce((sum, row) => sum + (row[key] || 0), 0);
                    } else if (key.includes('%')) {
                        // Calculate weighted percentage for totals
                        const questKey = 'Jobs with Questionnaires';
                        const eoKey = 'Jobs with Essay Question';
                        if (key === '% with Essay Question' && totals[questKey] > 0) {
                            totals[key] = ((totals[eoKey] / totals[questKey]) * 100).toFixed(1);
                        } else {
                            totals[key] = '';
                        }
                    } else {
                        totals[key] = '';
                    }
                });
                
                // Create total row cells
                Object.entries(totals).forEach(([key, value], index) => {
                    const td = document.createElement('td');
                    if (typeof value === 'number') {
                        td.textContent = value.toLocaleString();
                        td.style.textAlign = 'center';
                    } else if (key.includes('%') && value !== '') {
                        // Center percentage values
                        td.textContent = value;
                        td.style.textAlign = 'center';
                    } else if (index === 0) {
                        // Bold the TOTAL label
                        td.innerHTML = '<strong>' + value + '</strong>';
                    } else {
                        td.textContent = value;
                    }
                    totalsRow.appendChild(td);
                });
                
                tbody.appendChild(totalsRow);
                table.appendChild(tbody);
            }
            
            // Create header with sorting
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const columnKeys = Object.keys(data[0]);
            
            columnKeys.forEach((key, index) => {
                const th = document.createElement('th');
                th.textContent = key;
                th.className = 'sortable';
                th.setAttribute('data-column', index);
                
                th.addEventListener('click', function() {
                    const columnIndex = parseInt(this.getAttribute('data-column'));
                    
                    // Remove sort classes from all headers
                    headerRow.querySelectorAll('th').forEach(header => {
                        header.classList.remove('asc', 'desc');
                    });
                    
                    // Determine sort direction
                    if (currentSort.column === columnIndex && currentSort.direction === 'asc') {
                        currentSort.direction = 'desc';
                        this.classList.add('desc');
                    } else {
                        currentSort.direction = 'asc';
                        this.classList.add('asc');
                    }
                    currentSort.column = columnIndex;
                    
                    // Sort the data
                    tableData.sort((a, b) => {
                        const aVal = Object.values(a)[columnIndex];
                        const bVal = Object.values(b)[columnIndex];
                        
                        // Handle numeric vs string sorting
                        let comparison = 0;
                        if (typeof aVal === 'number' && typeof bVal === 'number') {
                            comparison = aVal - bVal;
                        } else {
                            comparison = String(aVal).localeCompare(String(bVal));
                        }
                        
                        return currentSort.direction === 'asc' ? comparison : -comparison;
                    });
                    
                    // Re-render the table body
                    renderTableBody();
                    
                    // Update show all button visibility after sort
                    const showAllBtn = document.querySelector(`[data-table="${elementId}"]`);
                    if (showAllBtn && showAllBtn.textContent.includes('Show Less')) {
                        // If showing all, make sure hidden rows stay visible
                        const hiddenRows = table.querySelectorAll('.hidden-row');
                        hiddenRows.forEach(row => {
                            row.style.display = '';
                        });
                    }
                });
                
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Initial render
            renderTableBody();
            
            container.appendChild(table);
            
            // Show/hide the "Show All" button if needed
            if (data.length > initialLimit) {
                const showAllBtn = document.querySelector(`[data-table="${elementId}"]`);
                if (showAllBtn) {
                    showAllBtn.style.display = 'block';
                    showAllBtn.textContent = `Show All (${data.length} total)`;
                    console.log(`Button shown for ${elementId}: ${data.length} items, limit ${initialLimit}`);
                }
            }
        }
        
        function createTimelineTable(elementId, data) {
            const container = document.getElementById(elementId);
            const table = document.createElement('table');
            table.className = 'table table-bordered heatmap-table';
            
            // Find max percentage for scaling
            let maxPercent = 0;
            data.forEach(row => {
                ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Monthly Percentage'].forEach(key => {
                    if (row[key] !== null && row[key] !== undefined) {
                        const percent = parseFloat(row[key]);
                        if (percent > maxPercent) maxPercent = percent;
                    }
                });
            });
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            ['Month', 'Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Monthly %', 'Total Jobs', 'Jobs with Questionnaires', 'Jobs with Essay Question'].forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            data.forEach(row => {
                const tr = document.createElement('tr');
                Object.entries(row).forEach(([key, value]) => {
                    const td = document.createElement('td');
                    if (key.includes('Week') || key === 'Monthly Percentage') {
                        if (value !== null) {
                            td.textContent = value + '%';
                            const percent = parseFloat(value);
                            // Scale to max percent in this table
                            const intensity = maxPercent > 0 ? percent / maxPercent : 0;
                            td.style.backgroundColor = `rgba(13, 110, 253, ${intensity})`;
                            td.style.color = intensity > 0.5 ? 'white' : 'black';
                        } else {
                            td.textContent = '—';
                            td.style.backgroundColor = '#f0f0f0';
                        }
                    } else {
                        // Format numbers with commas
                        if (typeof value === 'number') {
                            td.textContent = value.toLocaleString();
                        } else {
                            td.textContent = value;
                        }
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            // Add totals row
            const totalsRow = document.createElement('tr');
            totalsRow.className = 'table-info';
            totalsRow.style.fontWeight = 'bold';
            
            // Calculate totals
            const totals = {
                'Month': 'TOTAL',
                'Week 1': null,
                'Week 2': null,
                'Week 3': null,
                'Week 4': null,
                'Week 5': null,
                'Monthly Percentage': null,
                'Total Jobs': 0,
                'Jobs with Questionnaires': 0,
                'Jobs with Essay Question': 0
            };
            
            // Sum up the numeric columns
            data.forEach(row => {
                totals['Total Jobs'] += row['Total Jobs'] || 0;
                totals['Jobs with Questionnaires'] += row['Jobs with Questionnaires'] || 0;
                totals['Jobs with Essay Question'] += row['Jobs with Essay Question'] || 0;
            });
            
            // Calculate overall percentage (EO jobs / questionnaire jobs)
            if (totals['Jobs with Questionnaires'] > 0) {
                totals['Monthly Percentage'] = (totals['Jobs with Essay Question'] / totals['Jobs with Questionnaires'] * 100).toFixed(1);
            }
            
            // Create cells for totals row
            Object.entries(totals).forEach(([key, value]) => {
                const td = document.createElement('td');
                if (key === 'Month') {
                    td.innerHTML = '<strong>' + value + '</strong>';
                } else if (key === 'Monthly Percentage' && value !== null) {
                    td.textContent = value + '%';
                    td.style.textAlign = 'center';
                    td.style.backgroundColor = '#e9ecef';
                } else if (typeof value === 'number') {
                    td.textContent = value.toLocaleString();
                    td.style.textAlign = 'center';
                } else {
                    td.textContent = '';
                    td.style.backgroundColor = '#e9ecef';
                }
                totalsRow.appendChild(td);
            });
            
            tbody.appendChild(totalsRow);
            table.appendChild(tbody);
            
            container.appendChild(table);
        }
        
        let allJobsData = []; // Store all jobs data for CSV download
        
        function initJobsTable(data) {
            allJobsData = data; // Store for CSV download
            
            // Update counts
            document.getElementById('jobsTotal').textContent = data.length;
            document.getElementById('jobsShown').textContent = Math.min(50, data.length);
            
            const table = $('#jobsTable').DataTable({
                data: data,
                columns: [
                    { data: 'usajobs_link' },  // Use USAJobs control number as ID
                    { data: 'position_title' },
                    { data: 'occupation' },
                    { data: 'agency' },
                    { data: 'location' },
                    { data: 'grade' },
                    { data: 'service' },
                    { data: 'open_date' },
                    { data: 'close_date' },
                    { data: 'questionnaire_status' },
                    { 
                        data: 'usajobs_link',
                        render: function(data, type, row) {
                            if (type === 'export') {
                                return data ? 'https://www.usajobs.gov/job/' + data : '';
                            }
                            if (data) {
                                return '<a href="https://www.usajobs.gov/job/' + data + '" target="_blank" class="external-link" data-link-type="usajobs">View Job</a>';
                            }
                            return '';
                        }
                    },
                    { 
                        data: 'questionnaire_link',
                        render: function(data, type, row) {
                            if (type === 'export') {
                                return data || '';
                            }
                            if (data) {
                                return '<a href="' + data + '" target="_blank" class="external-link" data-link-type="questionnaire">View Questions</a>';
                            }
                            return '';
                        }
                    }
                ],
                pageLength: 50,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                scrollX: false,
                searching: true,
                dom: 'lfrtip',
                orderCellsTop: true,
                fixedHeader: true,
                order: [[7, 'desc']], // Sort by open date descending by default
                drawCallback: function() {
                    // Update counts based on filtered data
                    const api = this.api();
                    const info = api.page.info();
                    
                    // Update total to show filtered count
                    document.getElementById('jobsTotal').textContent = info.recordsDisplay;
                    
                    // Update shown count (current page end, but not more than total filtered)
                    const shownCount = Math.min(info.end, info.recordsDisplay);
                    document.getElementById('jobsShown').textContent = shownCount;
                    
                    // Track sorting
                    const order = api.order();
                    if (order && order.length > 0 && typeof gtag !== 'undefined') {
                        const columnIdx = order[0][0];
                        const direction = order[0][1];
                        const columnName = $(api.column(columnIdx).header()).text();
                        
                        gtag('event', 'sort_table', {
                            'event_category': 'engagement',
                            'event_label': columnName,
                            'value': direction
                        });
                    }
                },
                initComplete: function() {
                    // Setup column search
                    const api = this.api();
                    const columnNames = ['ID', 'Position Title', 'Occupation', 'Agency', 'Location', 'Grade', 'Service', 'Open Date', 'Close Date'];
                    
                    // Store active filters for each column
                    const columnFilters = {
                        0: [], 1: [], 2: [], 3: [], 4: [], 7: [], 8: []
                    };
                    
                    // Populate grade dropdown with checkboxes
                    const gradeDropdown = $('.grade-dropdown');
                    const uniqueGrades = [...new Set(allJobsData.map(job => job.grade))].sort();
                    uniqueGrades.forEach((grade, index) => {
                        if (grade) {
                            gradeDropdown.append(`
                                <div class="form-check">
                                    <input class="form-check-input grade-filter" type="checkbox" value="${grade}" id="grade${index}">
                                    <label class="form-check-label" for="grade${index}">${grade}</label>
                                </div>
                            `);
                        }
                    });
                    
                    // Function to update filter display
                    function updateFilterDisplay() {
                        const filterContainer = document.getElementById('activeFilters');
                        filterContainer.innerHTML = '';
                        
                        let hasFilters = false;
                        
                        // Show text search filters
                        Object.entries(columnFilters).forEach(([colIdx, filters]) => {
                            if (filters.length > 0) {
                                hasFilters = true;
                                filters.forEach((filter, index) => {
                                    const filterTag = document.createElement('div');
                                    filterTag.className = 'filter-tag';
                                    filterTag.innerHTML = `
                                        <span><strong>${columnNames[colIdx]}:</strong> "${filter}"</span>
                                        <span class="remove-filter" data-column="${colIdx}" data-index="${index}" title="Remove filter">×</span>
                                    `;
                                    filterContainer.appendChild(filterTag);
                                });
                            }
                        });
                        
                        // Show grade filters
                        const checkedGrades = $('.grade-filter:checked').map(function() {
                            return $(this).val();
                        }).get();
                        if (checkedGrades.length > 0) {
                            hasFilters = true;
                            const filterTag = document.createElement('div');
                            filterTag.className = 'filter-tag';
                            filterTag.innerHTML = `
                                <span><strong>${columnNames[4]}:</strong> ${checkedGrades.join(', ')}</span>
                                <span class="remove-filter" data-column="4" title="Remove filter">×</span>
                            `;
                            filterContainer.appendChild(filterTag);
                        }
                        
                        // Show service filters
                        const checkedServices = $('.service-filter:checked').map(function() {
                            return $(this).val();
                        }).get();
                        if (checkedServices.length > 0) {
                            hasFilters = true;
                            const filterTag = document.createElement('div');
                            filterTag.className = 'filter-tag';
                            filterTag.innerHTML = `
                                <span><strong>${columnNames[5]}:</strong> ${checkedServices.join(', ')}</span>
                                <span class="remove-filter" data-column="5" title="Remove filter">×</span>
                            `;
                            filterContainer.appendChild(filterTag);
                        }
                        
                        if (!hasFilters) {
                            filterContainer.innerHTML = '<small class="text-muted">No filters applied</small>';
                        }
                    }
                    
                    // Function to apply column filters
                    function applyColumnFilter(colIdx) {
                        const filters = columnFilters[colIdx];
                        if (filters && filters.length > 0) {
                            // Create regex pattern for OR search
                            const pattern = filters.map(term => term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|');
                            api.column(colIdx).search(pattern, true, false).draw();
                        } else {
                            api.column(colIdx).search('').draw();
                        }
                    }
                    
                    // Apply the search on text inputs
                    $('.column-search').on('keyup change clear', function(e) {
                        const colIdx = parseInt($(this).data('column'));
                        const searchValue = this.value.trim();
                        
                        // On Enter key, add to filters
                        if (e.type === 'keyup' && e.keyCode === 13) {
                            if (searchValue && !columnFilters[colIdx].includes(searchValue)) {
                                columnFilters[colIdx].push(searchValue);
                                this.value = ''; // Clear input
                                applyColumnFilter(colIdx);
                                updateFilterDisplay();
                                
                                // Track column search usage
                                if (typeof gtag !== 'undefined') {
                                    gtag('event', 'search', {
                                        'event_category': 'engagement',
                                        'event_label': columnNames[colIdx],
                                        'search_term': searchValue
                                    });
                                }
                            }
                            return;
                        }
                        
                        // For clear event, reset filters
                        if (e.type === 'clear') {
                            columnFilters[colIdx] = [];
                            applyColumnFilter(colIdx);
                            updateFilterDisplay();
                        }
                    });
                    
                    // Handle grade checkboxes
                    $('.grade-filter').on('change', function() {
                        const checkedGrades = $('.grade-filter:checked').map(function() {
                            return $(this).val();
                        }).get();
                        
                        // Update button text
                        const button = $('.grade-dropdown').closest('.dropdown').find('button');
                        if (checkedGrades.length === 0) {
                            button.text('All Grades');
                        } else if (checkedGrades.length === 1) {
                            button.text(checkedGrades[0]);
                        } else {
                            button.text(checkedGrades.length + ' Grades Selected');
                        }
                        
                        if (checkedGrades.length > 0) {
                            const pattern = '^(' + checkedGrades.map(g => g.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|') + ')$';
                            api.column(5).search(pattern, true, false).draw();
                        } else {
                            api.column(5).search('').draw();
                        }
                        updateFilterDisplay();
                    });
                    
                    // Handle service checkboxes
                    $('.service-filter').on('change', function() {
                        const checkedServices = $('.service-filter:checked').map(function() {
                            return $(this).val();
                        }).get();
                        
                        // Update button text
                        const button = $(this).closest('.dropdown').find('button');
                        if (checkedServices.length === 0) {
                            button.text('All Services');
                        } else if (checkedServices.length === 1) {
                            button.text(checkedServices[0]);
                        } else {
                            button.text(checkedServices.length + ' Selected');
                        }
                        
                        if (checkedServices.length > 0) {
                            const pattern = '^(' + checkedServices.join('|') + ')$';
                            api.column(6).search(pattern, true, false).draw();
                        } else {
                            api.column(6).search('').draw();
                        }
                        updateFilterDisplay();
                    });
                    
                    // Handle filter removal
                    $(document).on('click', '.remove-filter', function() {
                        const colIdx = parseInt($(this).data('column'));
                        const filterIndex = $(this).data('index');
                        
                        if (colIdx === 5) {
                            // Clear grade checkboxes
                            $('.grade-filter').prop('checked', false);
                            $('.grade-dropdown').closest('.dropdown').find('button').text('All Grades');
                            api.column(5).search('').draw();
                        } else if (colIdx === 6) {
                            // Clear service checkboxes
                            $('.service-filter').prop('checked', false);
                            $('.service-dropdown').closest('.dropdown').find('button').text('All Services');
                            api.column(6).search('').draw();
                        } else {
                            // Remove specific text filter
                            if (filterIndex !== undefined) {
                                columnFilters[colIdx].splice(filterIndex, 1);
                                applyColumnFilter(colIdx);
                            }
                        }
                        updateFilterDisplay();
                    });
                    
                    // Prevent sorting when clicking on search inputs
                    $('.search-row input, .search-row select, .search-row .dropdown').on('click', function(e) {
                        e.stopPropagation();
                    });
                    
                    // Keep dropdowns open when clicking inside
                    $('.dropdown-menu').on('click', function(e) {
                        e.stopPropagation();
                    });
                    
                    // Handle questionnaire status filter
                    $('#statusFilter').on('change', function() {
                        const selectedStatus = $(this).val();
                        
                        // Track filter usage in Google Analytics
                        if (typeof gtag !== 'undefined' && selectedStatus) {
                            gtag('event', 'filter_questionnaire_status', {
                                'event_category': 'engagement',
                                'event_label': selectedStatus
                            });
                        }
                        
                        if (selectedStatus) {
                            // Escape regex special characters
                            const escapedStatus = selectedStatus.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                            api.column(9).search('^' + escapedStatus + '$', true, false).draw();
                        } else {
                            api.column(9).search('').draw();
                        }
                    });
                    
                    // Initial display
                    updateFilterDisplay();
                }
            });
        }
        
        // CSV download function
        function downloadCSV() {
            // Track CSV download
            if (typeof gtag !== 'undefined') {
                gtag('event', 'download', {
                    'event_category': 'engagement',
                    'event_label': 'all_federal_jobs_csv',
                    'value': allJobsData.length
                });
            }
            
            const headers = ['USAJobs ID', 'Position Title', 'Occupation', 'Agency', 'Location', 'Grade', 'Service Type', 'Open Date', 'Close Date', 'Questionnaire Status', 'USAJobs Link', 'Questionnaire Link'];
            const csvContent = [
                headers.join(','),
                ...allJobsData.map(row => {
                    return [
                        row.usajobs_link || '',
                        '"' + (row.position_title || '').replace(/"/g, '""') + '"',
                        '"' + (row.occupation || '').replace(/"/g, '""') + '"',
                        '"' + (row.agency || '').replace(/"/g, '""') + '"',
                        '"' + (row.location || '').replace(/"/g, '""') + '"',
                        '"' + (row.grade || '').replace(/"/g, '""') + '"',
                        '"' + (row.service || '').replace(/"/g, '""') + '"',
                        row.open_date || '',
                        row.close_date || '',
                        '"' + (row.questionnaire_status || '').replace(/"/g, '""') + '"',
                        row.usajobs_link ? 'https://www.usajobs.gov/job/' + row.usajobs_link : '',
                        row.questionnaire_link || ''
                    ].join(',');
                })
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'all_federal_jobs.csv';
            link.click();
        }
        
        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // Track page view with custom dimensions
            if (typeof gtag !== 'undefined') {
                gtag('event', 'page_view', {
                    'page_title': 'Merit Hiring Plan Essay Tracker',
                    'page_path': window.location.pathname
                });
            }
            
            // Add event listener for CSV download button
            document.getElementById('downloadCSV').addEventListener('click', downloadCSV);
            
            // Track external link clicks
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('external-link')) {
                    const linkType = e.target.getAttribute('data-link-type');
                    const href = e.target.getAttribute('href');
                    
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'click', {
                            'event_category': 'outbound',
                            'event_label': linkType,
                            'transport_type': 'beacon',
                            'value': href
                        });
                    }
                }
            });
            
            // Add event listeners for "Show All" buttons
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('show-all-btn')) {
                    const tableId = e.target.getAttribute('data-table');
                    const tableContainer = document.getElementById(tableId);
                    const hiddenRows = tableContainer.querySelectorAll('.hidden-row');
                    
                    // Track "Show All" usage
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'show_all_data', {
                            'event_category': 'engagement',
                            'event_label': tableId,
                            'value': hiddenRows.length
                        });
                    }
                    
                    if (e.target.textContent.includes('Show All')) {
                        // Show all rows
                        hiddenRows.forEach(row => {
                            row.style.display = '';
                        });
                        e.target.textContent = 'Show Less';
                    } else {
                        // Hide extra rows
                        hiddenRows.forEach(row => {
                            row.style.display = 'none';
                        });
                        const total = hiddenRows.length + tableContainer.querySelectorAll('tbody tr:not(.hidden-row)').length;
                        e.target.textContent = `Show All (${total} total)`;
                    }
                }
            });
        });
    </script>
</body>
</html>